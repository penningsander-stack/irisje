// frontend/js/dashboard.js
const API_BASE = "https://irisje-backend.onrender.com/api";

document.addEventListener("DOMContentLoaded", initDashboard);

async function initDashboard() {
  const email = localStorage.getItem("userEmail");
  let companyId = localStorage.getItem("companyId");

  // üü£ Fallback voor beheerder (koppel bedrijf via e-mail)
  if (email === "info@irisje.nl" && !companyId) {
    try {
      const r = await fetch(`${API_BASE}/companies/byOwner/${encodeURIComponent(email)}`);
      const j = await r.json();
      if (r.ok && Array.isArray(j) && j.length) {
        companyId = j[0]._id;
        localStorage.setItem("companyId", companyId);
      }
    } catch (e) {
      console.error("Fout bij koppelen beheerder:", e);
    }
  }

  // UI hooks
  const $reqBody = byId("request-table-body");
  const $revBody = byId("review-table-body");
  const $statusFilter = byId("statusFilter");

  if (!companyId) {
    if ($reqBody) $reqBody.innerHTML =
      "<tr><td colspan='5' class='text-center text-gray-500 p-4'>Geen bedrijf gevonden (log opnieuw in).</td></tr>";
    if ($revBody) $revBody.innerHTML =
      "<tr><td colspan='5' class='text-center text-gray-500 p-4'>Geen bedrijf gevonden.</td></tr>";
    return;
  }

  // Data state
  let allRequests = [];
  let allReviews = [];

  // ====== Loaders ======
  async function loadRequests() {
    try {
      const r = await fetch(`${API_BASE}/requests/company/${companyId}`);
      const j = await r.json();
      if (!r.ok || !Array.isArray(j)) throw new Error("Ongeldig antwoord (requests)");
      // sorteer nieuwste eerst
      allRequests = [...j].sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
      renderRequestsTable(allRequests);
    } catch (e) {
      console.error("Fout bij laden aanvragen:", e);
      if ($reqBody) $reqBody.innerHTML =
        "<tr><td colspan='5' class='text-center text-red-600 p-4'>Fout bij laden aanvragen.</td></tr>";
      allRequests = [];
    }
  }

  async function loadReviews() {
    try {
      const r = await fetch(`${API_BASE}/reviews/company/${companyId}`);
      const j = await r.json();
      if (!r.ok || !Array.isArray(j)) throw new Error("Ongeldig antwoord (reviews)");
      // sorteer nieuwste eerst
      allReviews = [...j].sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
      renderReviewsTable(allReviews);
    } catch (e) {
      console.error("Fout bij laden reviews:", e);
      if ($revBody) $revBody.innerHTML =
        "<tr><td colspan='5' class='text-center text-red-600 p-4'>Fout bij laden reviews.</td></tr>";
      allReviews = [];
    }
  }

  // ====== Renderers ======
  function renderRequestsTable(list) {
    if (!$reqBody) return;
    if (!list || !list.length) {
      $reqBody.innerHTML =
        "<tr><td colspan='5' class='text-center text-gray-500 p-4'>Geen aanvragen gevonden.</td></tr>";
      updateStatsAndCharts();
      return;
    }

    const rows = list.map(req => {
      const d = new Date(req.createdAt || req.date);
      const datum = isNaN(d)
        ? "-"
        : d.toLocaleDateString("nl-NL", { day: "2-digit", month: "short", year: "numeric" });
      return `
        <tr class="border-t hover:bg-indigo-50 transition">
          <td>${esc(req.name)}</td>
          <td>${esc(req.email)}</td>
          <td>${esc(req.message)}</td>
          <td>${esc(req.status || "Nieuw")}</td>
          <td>${datum}</td>
        </tr>`;
    }).join("");

    $reqBody.innerHTML = rows;
    updateStatsAndCharts();
  }

  function renderReviewsTable(list) {
    if (!$revBody) return;
    if (!list || !list.length) {
      $revBody.innerHTML =
        "<tr><td colspan='5' class='text-center text-gray-500 p-4'>Nog geen reviews.</td></tr>";
      updateStatsAndCharts();
      return;
    }

    const rows = list.map(rev => {
      const d = new Date(rev.createdAt || rev.date);
      const datum = isNaN(d)
        ? "-"
        : d.toLocaleDateString("nl-NL", { day: "2-digit", month: "short", year: "numeric" });
      return `
        <tr class="border-t hover:bg-indigo-50 transition">
          <td>${esc(rev.name)}</td>
          <td>${"‚≠ê".repeat(rev.rating || 0)}</td>
          <td>${esc(rev.message)}</td>
          <td>${datum}</td>
          <td>
            ${
              rev.reported
                ? `<span class="text-xs text-gray-500 italic">Gemeld</span>`
                : `<button onclick="meldReview('${rev._id}')"
                    class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700">
                    Melden
                  </button>`
            }
          </td>
        </tr>`;
    }).join("");

    $revBody.innerHTML = rows;
    updateStatsAndCharts();
  }

  // ====== Review melden ======
  window.meldReview = async function (id) {
    if (!confirm("Weet je zeker dat je deze review wilt melden aan de beheerder?")) return;
    try {
      const r = await fetch(`${API_BASE}/reviews/report/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
      });
      if (!r.ok) throw new Error(`Server antwoordde met ${r.status}`);
      alert("‚úÖ Review is gemeld aan de beheerder.");
      await loadReviews();
    } catch (e) {
      console.error("Fout bij melden review:", e);
      alert("‚ùå Er ging iets mis bij het melden van de review.");
    }
  };

  // ====== Statistieken & grafieken ======
  let maandChart, statusChart;

  function updateStatsAndCharts() {
    // Totale statistieken
    const total = allRequests.length;
    const accepted = allRequests.filter(r => r.status === "Geaccepteerd").length;
    const rejected = allRequests.filter(r => r.status === "Afgewezen").length;
    const followedUp = allRequests.filter(r => r.status === "Opgevolgd").length;

    setText("total", total);
    setText("accepted", accepted);
    setText("rejected", rejected);
    setText("followed-up", followedUp);

    // Maandstatistieken (zelfde maand & jaar)
    const now = new Date();
    const thisMonthReqs = allRequests.filter(r => sameMonthYear(new Date(r.createdAt || r.date), now));
    const monthTotal = thisMonthReqs.length;
    const monthAccepted = thisMonthReqs.filter(r => r.status === "Geaccepteerd").length;

    const thisMonthReviews = allReviews.filter(rv => sameMonthYear(new Date(rv.createdAt || rv.date), now));
    const monthReviews = thisMonthReviews.length;

    const avgRating =
      allReviews.length
        ? (allReviews.reduce((s, rv) => s + (rv.rating || 0), 0) / allReviews.length).toFixed(1)
        : "‚Äì";

    setText("monthTotal", monthTotal);
    setText("monthAccepted", monthAccepted);
    setText("monthReviews", monthReviews);
    setText("avgRating", avgRating);

    // Grafiek: aanvragen per maand
    const ctx1 = byId("maandChart");
    const ctx2 = byId("statusChart");
    if (!ctx1 || !ctx2) return;

    const perMaand = {}; // { 'jan 2025': 3, ... }
    allRequests.forEach(r => {
      const d = new Date(r.createdAt || r.date);
      if (isNaN(d)) return;
      const key = `${d.toLocaleString("nl-NL", { month: "short" })} ${d.getFullYear()}`;
      perMaand[key] = (perMaand[key] || 0) + 1;
    });
    const labels = Object.keys(perMaand);
    const values = Object.values(perMaand);

    if (maandChart) maandChart.destroy();
    maandChart = new Chart(ctx1, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Aanvragen",
          data: values,
          borderColor: "#4F46E5",
          backgroundColor: "rgba(79,70,229,0.2)",
          fill: true,
          tension: 0.4
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });

    const statusData = {
      Nieuw: allRequests.filter(r => r.status === "Nieuw" || !r.status).length,
      Geaccepteerd: accepted,
      Afgewezen: rejected,
      Opgevolgd: followedUp
    };
    if (statusChart) statusChart.destroy();
    statusChart = new Chart(ctx2, {
      type: "doughnut",
      data: {
        labels: Object.keys(statusData),
        datasets: [{
          data: Object.values(statusData),
          backgroundColor: ["#4F46E5", "#22c55e", "#ef4444", "#eab308"]
        }]
      },
      options: { responsive: true, plugins: { legend: { position: "bottom" } } }
    });
  }

  // ====== Filter ======
  if ($statusFilter) {
    $statusFilter.addEventListener("change", () => {
      const val = $statusFilter.value;
      const list =
        val === "ALLE"
          ? allRequests
          : allRequests.filter(r => (r.status || "Nieuw") === val);
      renderRequestsTable(list);
    });
  }

  // ====== Uitloggen ======
  const $logout = byId("logoutBtn");
  if ($logout) {
    $logout.addEventListener("click", () => {
      document.body.classList.add("fade-out");
      setTimeout(() => {
        localStorage.clear();
        window.location.href = "login.html";
      }, 600);
    });
  }

  // Start
  await loadRequests();
  await loadReviews();
}

// ====== Helpers ======
function byId(id) { return document.getElementById(id); }
function setText(id, val) { const el = byId(id); if (el) el.textContent = val; }
function sameMonthYear(a, b) {
  if (!(a instanceof Date) || isNaN(a)) return false;
  return a.getMonth() === b.getMonth() && a.getFullYear() === b.getFullYear();
}
function esc(v) {
  if (v == null) return "";
  return String(v).replace(/[&<>"']/g, s => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#39;" }[s]));
}
