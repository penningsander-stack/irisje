<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Admin – Irisje</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <script>
    const wachtwoord = prompt("Voer het beheerderswachtwoord in:");
    if (wachtwoord !== "beheer123") {
      alert("Toegang geweigerd.");
      window.location.href = "/";
    }
  </script>

  <header>
    <h1>Beheer – Irisje</h1>
  </header>

  <main>
    <section>
      <h2>Nieuw bedrijf toevoegen</h2>
      <input id="newName" placeholder="Naam" />
      <input id="newCategory" placeholder="Categorie" />
      <input id="newLocation" placeholder="Locatie" />
      <textarea id="newDescription" placeholder="Beschrijving"></textarea>
      <button onclick="addCompany()">Toevoegen</button>
    </section>

    <hr>

    <section>
      <h2>Alle bedrijven</h2>
      <div id="companyList"></div>
    </section>
  </main>

  <script>
    const API_BASE_URL = 'https://irisje.onrender.com';

    async function fetchCompanies() {
      const res = await fetch(`${API_BASE_URL}/api/companies`);
      const companies = await res.json();
      const list = document.getElementById('companyList');
      list.innerHTML = '';

      for (const company of companies) {
        const reviewsRes = await fetch(`${API_BASE_URL}/api/reviews/company/${company._id}`);
        const reviews = await reviewsRes.json();

        const div = document.createElement('div');
        div.innerHTML = `
          <h3>${company.name}</h3>
          <p>${company.category} – ${company.location}</p>
          <p>${company.description}</p>

          <button onclick="deleteCompany('${company._id}')">Verwijderen</button>
          <button onclick="editCompany('${company._id}')">Bewerken</button>

          <div id="edit-${company._id}" style="display:none;">
            <input id="name-${company._id}" value="${company.name}" />
            <input id="category-${company._id}" value="${company.category}" />
            <input id="location-${company._id}" value="${company.location}" />
            <textarea id="description-${company._id}">${company.description}</textarea>
            <button onclick="saveCompany('${company._id}')">Opslaan</button>
          </div>

          <details>
            <summary>Reviews (${reviews.length})</summary>
            <ul>
              ${reviews.map(r => `
                <li>
                  <strong>${r.name}</strong> (${r.rating}/5): ${r.comment}
                  <button onclick="deleteReview('${r._id}')">Verwijder</button>
                </li>
              `).join('')}
            </ul>
          </details>
        `;
        list.appendChild(div);
      }
    }

    function editCompany(id) {
      document.getElementById(`edit-${id}`).style.display = 'block';
    }

    async function saveCompany(id) {
      const name = document.getElementById(`name-${id}`).value;
      const category = document.getElementById(`category-${id}`).value;
      const location = document.getElementById(`location-${id}`).value;
      const description = document.getElementById(`description-${id}`).value;

      await fetch(`${API_BASE_URL}/api/companies/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, category, location, description })
      });

      fetchCompanies();
    }

    async function deleteCompany(id) {
      if (confirm('Weet je zeker dat je dit bedrijf wilt verwijderen?')) {
        await fetch(`${API_BASE_URL}/api/companies/${id}`, { method: 'DELETE' });
        fetchCompanies();
      }
    }

    async function addCompany() {
      const name = document.getElementById('newName').value;
      const category = document.getElementById('newCategory').value;
      const location = document.getElementById('newLocation').value;
      const description = document.getElementById('newDescription').value;

      await fetch(`${API_BASE_URL}/api/companies`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, category, location, description })
      });

      document.getElementById('newName').value = '';
      document.getElementById('newCategory').value = '';
      document.getElementById('newLocation').value = '';
      document.getElementById('newDescription').value = '';

      fetchCompanies();
    }

    async function deleteReview(id) {
      if (confirm('Review verwijderen?')) {
        await fetch(`${API_BASE_URL}/api/reviews/${id}`, { method: 'DELETE' });
        fetchCompanies();
      }
    }

    fetchCompanies();
  </script>
</body>
</html>
