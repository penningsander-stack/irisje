<!-- frontend/results.html -->
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zoekresultaten ‚Äì Irisje.nl</title>
  <meta name="description" content="Bekijk bedrijven bij jou in de buurt, vergelijk reviews en vraag direct een offerte aan." />
  <meta name="theme-color" content="#4F46E5" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link rel="stylesheet" href="style.css?v=20251205" />

</head>

<body class="irisje-body flex flex-col min-h-screen fade-seq">
  <!-- HEADER -->
  <header class="irisje-header sticky top-0 z-40">
    <div class="max-w-6xl mx-auto flex items-center justify-between px-4 py-3 lg:py-4">
      <a href="index.html" class="flex items-center space-x-2">
        <span class="inline-flex items-center justify-center w-9 h-9 rounded-2xl bg-white/90 text-indigo-700 text-sm font-bold shadow-brand">
          I
        </span>
        <div class="flex flex-col leading-tight">
          <span class="font-semibold text-sm text-slate-900 tracking-tight">Irisje.nl</span>
          <span class="text-[11px] text-slate-500 hidden sm:block">Vind direct een betrouwbare vakman</span>
        </div>
      </a>

      <nav class="hidden sm:flex items-center space-x-6 text-xs font-medium text-slate-600">
        <a href="results.html" class="nav-link">Bedrijven</a>
        <a href="login.html" class="nav-link">Voor bedrijven</a>
      </nav>

      <div class="flex items-center space-x-2">
        <a href="results.html" class="hidden sm:inline-flex btn-ghost btn-xs">
          Zoeken
        </a>
        <a href="login.html" class="inline-flex btn-primary btn-xs">
          Inloggen
        </a>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="results-main">
    <!-- Titel & context -->
    <section class="results-header-bar">
      <div class="results-title-block">
        <h1>
          <span>üîé</span>
          <span>Bedrijven in jouw regio</span>
        </h1>
        <p>
          Vergelijk bedrijven, lees reviews en vraag in √©√©n keer een offerte aan bij maximaal vijf bedrijven.
        </p>
      </div>
      <div class="results-meta" id="filterMessage">
        Resultaten worden geladen‚Ä¶
      </div>
    </section>

    <!-- Filterkaart -->
    <section aria-label="Filter bedrijven">
      <div class="filter-card">
        <form id="filterForm" class="filters-grid" novalidate>
          <div>
            <label for="filterCategory" class="filter-label">Categorie</label>
            <input
              id="filterCategory"
              type="text"
              class="form-input filter-input"
              placeholder="Bijv. loodgieter, schilder, elektricien..."
            />
          </div>
          <div>
            <label for="filterCity" class="filter-label">Plaats</label>
            <input
              id="filterCity"
              type="text"
              class="form-input filter-input"
              placeholder="Bijv. Amsterdam, Rotterdam..."
            />
          </div>
          <div style="display:flex;align-items:flex-end;justify-content:flex-start;">
            <button type="submit" class="btn-primary w-full">
              Zoeken
            </button>
          </div>
        </form>

        <div class="filter-footer">
          <span>
            <span class="filter-footer-badge">Slim zoeken</span>
            Gebruik categorie + plaats voor de beste matches.
          </span>
          <span id="filterCountsHint">
            Resultaten worden opgehaald‚Ä¶
          </span>
        </div>
      </div>
    </section>

    <!-- Selectiebalk -->
    <section id="selectionBar" class="selection-bar hidden">
      <div>
        <p class="text-sm text-indigo-900 font-medium">
          Geselecteerde bedrijven: <strong><span id="selectedCount">0</span>/5</strong>
        </p>
        <p id="selectedNames" class="selection-names"></p>
      </div>
      <div class="selection-actions">
        <button id="openRequestForm" class="btn-primary btn-xs" disabled>
          Offerte aanvragen
        </button>
        <button id="clearSelection" type="button" class="selection-clear">
          Alles deselecteren
        </button>
      </div>
    </section>

    <!-- Aanvraagformulier -->
    <section id="requestFormBox" class="request-box hidden">
      <div>
        <h2 class="request-header-title">Offerte aanvragen bij geselecteerde bedrijven</h2>
        <p class="request-header-sub">
          Je aanvraag wordt verstuurd naar maximaal vijf bedrijven tegelijk. Zij nemen rechtstreeks contact met je op.
        </p>
      </div>

      <form id="requestForm" class="request-grid" novalidate>
        <div>
          <label for="rqName" class="filter-label">Je naam</label>
          <input
            id="rqName"
            name="rqName"
            type="text"
            class="form-input"
            placeholder="Bijv. Sander"
            required
          />
          <p id="errName" class="error-text hidden"></p>
        </div>

        <div>
          <label for="rqEmail" class="filter-label">E-mailadres</label>
          <input
            id="rqEmail"
            name="rqEmail"
            type="email"
            class="form-input"
            placeholder="jouw@email.nl"
            required
          />
          <p id="errEmail" class="error-text hidden"></p>
        </div>

        <div>
          <label for="rqPhone" class="filter-label">Telefoonnummer</label>
          <input
            id="rqPhone"
            name="rqPhone"
            type="tel"
            class="form-input"
            placeholder="10 cijfers"
            required
          />
          <p id="errPhone" class="error-text hidden"></p>
        </div>

        <div class="request-full">
          <label for="rqMessage" class="filter-label">Beschrijf je klus of vraag</label>
          <textarea
            id="rqMessage"
            name="rqMessage"
            rows="3"
            class="form-input"
            placeholder="Vertel kort wat er gedaan moet worden, wanneer en eventuele bijzonderheden."
            required
          ></textarea>
          <p id="errMessage" class="error-text hidden"></p>
        </div>

        <div class="request-full">
          <p id="rqStatus" class="rq-status"></p>
        </div>

        <div class="request-full request-actions">
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            <button id="submitRequestBtn" type="submit" class="btn-primary">
              Verstuur aanvraag
            </button>
            <button type="button" id="closeRequestForm" class="btn-ghost">
              Annuleren
            </button>
          </div>
          <p class="request-note">
            üîí Je gegevens worden alleen gedeeld met de geselecteerde bedrijven.
          </p>
        </div>
      </form>
    </section>

    <!-- Resultaten -->
    <section aria-label="Zoekresultaten">
      <div id="resultsContainer" class="results-list">
        <div class="text-sm text-gray-500">Resultaten worden geladen...</div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer-shell card-fade-in">
    <div class="max-w-6xl mx-auto px-4 py-6 flex flex-col sm:flex-row items-center justify-between gap-3">
      <p class="text-[11px] text-slate-400">
        ¬© 2025 Irisje.nl ‚Äì Alle rechten voorbehouden
      </p>
      <div class="flex flex-wrap gap-3 text-[11px] text-slate-400">
        <a href="results.html" class="link-inline">Bedrijven</a>
        <a href="login.html" class="link-inline">Voor bedrijven</a>
        <a href="error.html" class="link-inline">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    // Full script wrapped to avoid race conditions and undefined references
    document.addEventListener("DOMContentLoaded", () => {
      const API_BASE = "https://irisje-backend.onrender.com/api";
      const MAX_SELECTION = 5;
      const selectedMap = new Map();

      const filterMessageEl = document.getElementById("filterMessage");
      const filterCountsHint = document.getElementById("filterCountsHint");

      // Validators (returns true or error message)
      const validators = {
        rqName: val => val.trim().length >= 2 || "Voer je naam in.",
        rqEmail: val => /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(val) || "Voer een geldig e-mailadres in.",
        rqPhone: val => /^\\d{10}$/.test(val) || "Voer 10 cijfers in.",
        rqMessage: val => val.trim().length >= 5 || "Geef een korte omschrijving."
      };

      // helper: set error / clear error
      function setError(el, errEl, msg) {
        if (!el || !errEl) return;
        if (msg === true || !msg) {
          el.classList.remove("error-border");
          errEl.classList.add("hidden");
          errEl.textContent = "";
        } else {
          el.classList.add("error-border");
          errEl.classList.remove("hidden");
          errEl.textContent = msg;
        }
      }

      // realtime validation binding
      Object.keys(validators).forEach(id => {
        const el = document.getElementById(id);
        const err = document.getElementById("err" + id.slice(2));
        if (!el || !err) return;
        el.addEventListener("input", () => {
          const valid = validators[id](el.value);
          setError(el, err, valid === true ? null : valid);
        });
      });

      // selection UI
      function updateSelectionUI() {
        const bar = document.getElementById("selectionBar");
        const count = document.getElementById("selectedCount");
        const names = document.getElementById("selectedNames");
        const btn = document.getElementById("openRequestForm");
        const arr = Array.from(selectedMap.values());

        count.textContent = arr.length;

        if (arr.length === 0) {
          bar.classList.add("hidden");
          if (btn) btn.disabled = true;
          names.textContent = "";
        } else {
          bar.classList.remove("hidden");
          if (btn) btn.disabled = false;
          names.textContent = arr.map(c => c.name).join(", ");
        }
      }

      // helper: escape html for text nodes (basic)
      function escapeHtml(str) {
        if (!str) return "";
        return String(str).replace(/[&<>\"']/g, function(m) {
          return ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[m]);
        });
      }

      // escape for attribute (minimally)
      function escapeHtmlAttr(str) {
        return escapeHtml(str).replace(/"/g, "&quot;");
      }

      // load results with sorting + top highlight
      async function loadResults(cat = "", city = "") {
        const container = document.getElementById("resultsContainer");
        if (!container) return;

        container.innerHTML = "<div class='text-sm text-gray-500'>‚è≥ Resultaten worden geladen...</div>";
        if (filterMessageEl) filterMessageEl.textContent = "Resultaten worden geladen‚Ä¶";
        if (filterCountsHint) filterCountsHint.textContent = "Resultaten worden opgehaald‚Ä¶";

        try {
          const res = await fetch(
            \`\${API_BASE}/companies/search?category=\${encodeURIComponent(cat)}&city=\${encodeURIComponent(city)}\`
          );
          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            throw new Error(\`Serverfout: \${res.status} \${txt}\`);
          }

          const data = await res.json();
          let items = data.items || [];

          // sort: rating desc -> reviewCount desc -> name asc
          items.sort((a, b) => {
            const ra = a.avgRating || 0, rb = b.avgRating || 0;
            if (rb !== ra) return rb - ra;
            const ca = a.reviewCount || 0, cb = b.reviewCount || 0;
            if (cb !== ca) return cb - ca;
            return (a.name || "").localeCompare(b.name || "");
          });

          if (items.length === 0) {
            container.innerHTML =
              "<div class='result-card' style='text-align:center;font-size:0.85rem;color:#6b7280;'>Geen bedrijven gevonden. Pas je filters aan of probeer een andere plaats.</div>";
            if (filterMessageEl) filterMessageEl.textContent = "Geen resultaten gevonden";
            if (filterCountsHint) filterCountsHint.textContent = "Geen bedrijven gevonden voor deze combinatie.";
            return;
          }

          container.innerHTML = items.map((c, i) => {
            const highlightClass = i < 5 ? "top-highlight" : "";
            const roundedRating = c.avgRating ? Math.round(c.avgRating * 10) / 10 : null;
            const stars = c.avgRating ? "‚≠ê".repeat(Math.round(c.avgRating)) : "‚Äî";
            const categories = Array.isArray(c.categories) ? c.categories.join(", ") : (c.categories || "");
            const reviewsText = \`\${c.reviewCount || 0} review\${(c.reviewCount || 0) === 1 ? "" : "s"}\`;

            return \`
            <article class="result-card \${highlightClass}">
              <div class="result-header">
                <div>
                  <h2 class="result-title">\${escapeHtml(c.name)}</h2>
                  <div class="result-location">\${escapeHtml(c.city || "")}</div>
                  <div class="result-categories">\${escapeHtml(categories)}</div>
                  <p class="result-tagline">\${escapeHtml(c.tagline || "")}</p>
                </div>
                <div class="result-rating">
                  <div class="result-stars">\${stars}</div>
                  <div class="result-reviewcount">\${roundedRating ? \`\${roundedRating} / 5,0\` : "Nog geen beoordeling"}</div>
                  <div class="result-reviewcount">\${reviewsText}</div>
                </div>
              </div>
              <div class="result-footer">
                <div class="result-actions">
                  <a
                    href="company.html?slug=\${encodeURIComponent(c.slug)}"
                    class="btn-primary btn-xs"
                  >
                    Bekijk profiel
                  </a>
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      class="company-select"
                      data-id="\${c._id}"
                      data-name="\${escapeHtmlAttr(c.name)}"
                    />
                    Aanvragen
                  </label>
                </div>
                <div class="result-verified">
                  \${c.isVerified ? "‚úÖ Geverifieerd bedrijf" : "‚è≥ Nog niet geverifieerd"}
                </div>
              </div>
            </article>\`;
          }).join("");

          const countText = \`\${items.length} resultaat\${items.length > 1 ? "en" : ""} gevonden\`;
          if (filterMessageEl) filterMessageEl.textContent = countText;
          if (filterCountsHint) filterCountsHint.textContent = countText;

          // attach checkbox listeners safely
          container.querySelectorAll(".company-select").forEach(chk => {
            chk.addEventListener("change", e => {
              const id = e.target.dataset.id;
              const name = e.target.dataset.name || "Onbekend";
              if (e.target.checked) {
                if (selectedMap.size >= MAX_SELECTION) {
                  e.target.checked = false;
                  alert("Je kunt maximaal 5 bedrijven selecteren.");
                  return;
                }
                selectedMap.set(id, { id, name });
              } else {
                selectedMap.delete(id);
              }
              updateSelectionUI();
            });
          });

        } catch (err) {
          console.error("Fout bij loadResults:", err);
          const container = document.getElementById("resultsContainer");
          if (container) {
            container.innerHTML =
              "<div class='result-card' style='border-color:#fecaca;color:#b91c1c;background:#fef2f2;'>Er ging iets mis bij het laden van de resultaten. Probeer het later opnieuw.</div>";
          }
          if (filterMessageEl) filterMessageEl.textContent = "Er is een fout opgetreden";
          if (filterCountsHint) filterCountsHint.textContent = "Kon de resultaten niet ophalen.";
        }
      }

      // open/close request form
      const openBtn = document.getElementById("openRequestForm");
      const requestBox = document.getElementById("requestFormBox");
      const clearBtn = document.getElementById("clearSelection");
      if (openBtn) {
        openBtn.addEventListener("click", () => {
          if (!requestBox) return;
          requestBox.classList.remove("hidden");
          setTimeout(() => {
            requestBox.scrollIntoView({ behavior: "smooth", block: "center" });
          }, 150);
        });
      }
      const closeBtn = document.getElementById("closeRequestForm");
      if (closeBtn) {
        closeBtn.addEventListener("click", () => {
          if (!requestBox) return;
          requestBox.classList.add("hidden");
        });
      }
      if (clearBtn) {
        clearBtn.addEventListener("click", () => {
          document.querySelectorAll(".company-select").forEach(chk => chk.checked = false);
          selectedMap.clear();
          updateSelectionUI();
          if (requestBox) requestBox.classList.add("hidden");
        });
      }

      // submit request
      const requestForm = document.getElementById("requestForm");
      const rqStatus = document.getElementById("rqStatus");
      if (requestForm) {
        requestForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!rqStatus) return;
          rqStatus.style.opacity = "1";

          const nameEl = document.getElementById("rqName");
          const emailEl = document.getElementById("rqEmail");
          const phoneEl = document.getElementById("rqPhone");
          const msgEl = document.getElementById("rqMessage");

          const entries = [
            ["rqName", nameEl],
            ["rqEmail", emailEl],
            ["rqPhone", phoneEl],
            ["rqMessage", msgEl]
          ];

          let firstInvalid = null;
          for (const [key, el] of entries) {
            if (!el) continue;
            const valid = validators[key](el.value);
            const errEl = document.getElementById("err" + key.slice(2));
            setError(el, errEl, valid === true ? null : valid);
            if (valid !== true && !firstInvalid) firstInvalid = el;
          }
          if (firstInvalid) {
            rqStatus.textContent = "‚ùå Controleer de invoer.";
            rqStatus.className = "rq-status text-red-600";
            firstInvalid.focus();
            return;
          }

          const companies = Array.from(selectedMap.values()).map(c => c.id);
          if (companies.length === 0) {
            rqStatus.textContent = "‚ùå Selecteer eerst √©√©n of meer bedrijven.";
            rqStatus.className = "rq-status text-red-600";
            return;
          }

          try {
            rqStatus.textContent = "‚è≥ Aanvraag wordt verzonden...";
            rqStatus.className = "rq-status text-gray-500";

            const payload = {
              customerName: nameEl.value.trim(),
              customerEmail: emailEl.value.trim(),
              customerPhone: phoneEl.value.trim(),
              message: msgEl.value.trim(),
              companies
            };

            const res = await fetch(\`\${API_BASE}/publicRequests/multi\`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });

            const json = await res.json().catch(() => ({ ok: false, error: "Geen JSON" }));
            if (!res.ok || !json.ok) {
              console.error("server error", res.status, json);
              throw new Error(json.error || "Serverfout");
            }

            rqStatus.textContent = "‚úÖ Aanvraag succesvol verzonden.";
            rqStatus.className = "rq-status text-green-600";
            requestForm.reset();
            document.querySelectorAll(".company-select").forEach(chk => chk.checked = false);
            selectedMap.clear();
            updateSelectionUI();

            setTimeout(() => {
              if (requestBox) requestBox.classList.add("hidden");
            }, 900);

            setTimeout(() => {
              rqStatus.classList.add("fade-out");
              setTimeout(() => {
                rqStatus.textContent = "";
                rqStatus.classList.remove("fade-out");
              }, 700);
            }, 2000);

          } catch (err) {
            console.error("Aanvraag fout:", err);
            rqStatus.textContent = "‚ùå Er ging iets mis bij het verzenden.";
            rqStatus.className = "rq-status text-red-600";
          }
        });
      }

      // initial load (from query)
      const q = new URLSearchParams(window.location.search);
      const initialCategory = q.get("category") || "";
      const initialCity = q.get("city") || "";

      const fc = document.getElementById("filterCategory");
      const fy = document.getElementById("filterCity");
      if (fc) fc.value = initialCategory;
      if (fy) fy.value = initialCity;

      const filterForm = document.getElementById("filterForm");
      if (filterForm) {
        filterForm.addEventListener("submit", (e) => {
          e.preventDefault();
          loadResults((fc && fc.value) || "", (fy && fy.value) || "");
        });
      }

      // initial call
      loadResults(initialCategory, initialCity);
    });
  </script>
</body>
</html>
