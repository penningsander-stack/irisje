<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Aanvraag versturen – Irisje.nl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body class="irisje-body">

<header class="site-header">
  <div class="container">
    <a href="/" class="logo">Irisje.nl</a>
  </div>
</header>

<main class="container">
  <div class="card-premium">
    <h1 class="card-title">Aanvraag versturen</h1>
    <p class="card-subtitle">
      Je aanvraag wordt verstuurd naar de door jou geselecteerde bedrijven.
    </p>

    <!-- Geselecteerde bedrijven -->
    <div id="selectedCompaniesBox" class="selected-box" style="display:none;">
      <div class="selected-title">Geselecteerde bedrijven</div>
      <ul id="selectedCompaniesList" class="selected-list"></ul>
    </div>

    <form id="requestForm" novalidate>
      <div class="field">
        <label for="name">Naam</label>
        <input id="name" type="text" required>
      </div>

      <div class="field">
        <label for="email">E-mailadres</label>
        <input id="email" type="email" required>
      </div>

      <!-- NIEUW: Telefoonnummer (optioneel) -->
      <div class="field">
        <label for="phone">Telefoonnummer <span style="color:#888;font-weight:400;">(optioneel)</span></label>
        <input
          id="phone"
          type="tel"
          placeholder="Bijv. 06 12345678"
          autocomplete="tel">
      </div>

      <div class="field">
        <label for="message">Omschrijving van je aanvraag</label>
        <textarea id="message" rows="4" required></textarea>
      </div>

      <button type="submit" id="submitBtn" class="btn-primary">
        Aanvraag indienen
      </button>
    </form>

    <p id="statusMessage" class="status-message"></p>
  </div>
</main>

<footer class="site-footer">
  <div class="container">
    <p>© Irisje.nl</p>
  </div>
</footer>

<style>
  /* ---------- Premium polish (lokale scope) ---------- */
  .card-premium{
    max-width:560px;
    margin:72px auto 0;
    background:#fff;
    padding:48px;
    border-radius:14px;
    box-shadow:0 22px 50px rgba(0,0,0,.12);
  }
  .card-title{margin-bottom:8px;}
  .card-subtitle{margin-bottom:26px;color:#666;}

  .field{margin-bottom:26px;}
  .field label{display:block;margin-bottom:8px;font-weight:500;}
  .field input,
  .field textarea{
    width:100%;
    min-height:56px;
    padding:14px 16px;
    border-radius:10px;
    border:1px solid #d0d0d0;
    background:#fafafa;
    font-size:15px;
    transition:border-color .15s, box-shadow .15s, background .15s;
  }
  .field textarea{min-height:128px;resize:vertical;}
  .field input:focus,
  .field textarea:focus{
    outline:none;
    border-color:#4f46e5;
    background:#fff;
    box-shadow:0 0 0 3px rgba(79,70,229,.12);
  }

  .btn-primary{
    width:100%;
    min-height:56px;
    font-size:15px;
  }
  .btn-primary[disabled]{opacity:.7;cursor:not-allowed;}

  .status-message{margin-top:18px;min-height:1em;}

  .selected-box{
    margin-bottom:28px;
    padding:16px 18px;
    border-radius:12px;
    background:#fafafa;
    border:1px solid #e6e6e6;
  }
  .selected-title{font-weight:600;margin-bottom:8px;}
  .selected-list{margin:0;padding-left:18px;}
</style>

<script>
  function safeJsonParse(raw){ try{ return JSON.parse(raw); }catch(e){ return null; } }

  const params = new URLSearchParams(window.location.search);
  const requestId = params.get("requestId");

  const formEl = document.getElementById("requestForm");
  const statusEl = document.getElementById("statusMessage");
  const submitBtn = document.getElementById("submitBtn");

  if (!requestId) {
    statusEl.textContent = "Fout: aanvraagcontext ontbreekt (requestId).";
    formEl.style.display = "none";
    throw new Error("requestId ontbreekt");
  }

  const selectedCompanies = Array.isArray(safeJsonParse(sessionStorage.getItem("selectedCompanies")))
    ? safeJsonParse(sessionStorage.getItem("selectedCompanies"))
    : [];
  const selectedCompanyIds = Array.isArray(safeJsonParse(sessionStorage.getItem("selectedCompanyIds")))
    ? safeJsonParse(sessionStorage.getItem("selectedCompanyIds"))
    : [];

  const boxEl = document.getElementById("selectedCompaniesBox");
  const listEl = document.getElementById("selectedCompaniesList");

  if (boxEl && listEl && selectedCompanies.length) {
    boxEl.style.display = "block";
    listEl.innerHTML = "";
    selectedCompanies.forEach(c => {
      const li = document.createElement("li");
      li.textContent = (c?.name || "Onbekend bedrijf") + (c?.city ? ` (${c.city})` : "");
      listEl.appendChild(li);
    });
  }

  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = "Bezig met versturen…";
    statusEl.textContent = "";

    const payload = {
      requestId,
      name: document.getElementById("name").value.trim(),
      email: document.getElementById("email").value.trim(),
      phone: document.getElementById("phone").value.trim() || undefined,
      message: document.getElementById("message").value.trim(),
      companyIds: selectedCompanyIds
    };

    try{
      const res = await fetch("https://irisje-backend.onrender.com/api/requests",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.message || "Versturen mislukt");

      sessionStorage.setItem("requestSent","1");
      sessionStorage.setItem("sentCompanies", JSON.stringify(selectedCompanies));
      window.location.href = "/thank-you.html";
    }catch(err){
      statusEl.textContent = "Versturen mislukt: " + err.message;
      submitBtn.disabled = false;
      submitBtn.textContent = "Aanvraag indienen";
    }
  });
</script>

</body>
</html>
